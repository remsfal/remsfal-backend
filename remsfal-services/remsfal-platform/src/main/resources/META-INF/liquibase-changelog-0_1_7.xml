<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!--
#
# Author: GitHub Copilot
#
 -->
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="remsfal-backend-0.1.7-tenant-many-to-many" author="github-copilot">
        <comment>Refactor tenants to many-to-many relationship with rental agreements for tenant reuse across agreements</comment>

        <!-- Add project_id to tenants table to scope tenants to a project -->
        <addColumn tableName="tenants">
            <column name="project_id" type="uuid">
                <constraints nullable="true" />
            </column>
        </addColumn>

        <!-- Populate project_id from the related rental agreement -->
        <sql>
            UPDATE tenants t
            SET project_id = (
                SELECT ra.project_id
                FROM rental_agreements ra
                WHERE ra.id = t.agreement_id
            )
        </sql>

        <!-- Make project_id not nullable after population -->
        <addNotNullConstraint tableName="tenants" columnName="project_id" columnDataType="uuid" />

        <!-- Add foreign key constraint for project_id -->
        <addForeignKeyConstraint constraintName="fk_tenant_project_id"
            baseTableName="tenants" baseColumnNames="project_id"
            referencedTableName="projects" referencedColumnNames="id"
            onDelete="CASCADE" onUpdate="RESTRICT" />

        <!-- Create index on project_id for performance -->
        <createIndex indexName="idx_tenant_project_fk" tableName="tenants">
            <column name="project_id" type="uuid" />
        </createIndex>

        <!-- Create index on first_name and last_name for tenant lookup -->
        <createIndex indexName="idx_tenant_name_lookup" tableName="tenants">
            <column name="first_name" type="varchar(255)" />
            <column name="last_name" type="varchar(255)" />
        </createIndex>

        <!-- Create rental_agreement_tenants join table for many-to-many relationship -->
        <createTable tableName="rental_agreement_tenants">
            <column name="rental_agreement_id" type="uuid">
                <constraints nullable="false" />
            </column>
            <column name="tenant_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </createTable>

        <!-- Add primary key to join table -->
        <addPrimaryKey constraintName="pk_rental_agreement_tenants"
            tableName="rental_agreement_tenants"
            columnNames="rental_agreement_id,tenant_id" />

        <!-- Add foreign key constraints for join table -->
        <addForeignKeyConstraint constraintName="fk_rat_rental_agreement_id"
            baseTableName="rental_agreement_tenants" baseColumnNames="rental_agreement_id"
            referencedTableName="rental_agreements" referencedColumnNames="id"
            onDelete="CASCADE" onUpdate="RESTRICT" />

        <addForeignKeyConstraint constraintName="fk_rat_tenant_id"
            baseTableName="rental_agreement_tenants" baseColumnNames="tenant_id"
            referencedTableName="tenants" referencedColumnNames="id"
            onDelete="CASCADE" onUpdate="RESTRICT" />

        <!-- Create indexes on join table for performance -->
        <createIndex indexName="idx_rat_rental_agreement_fk" tableName="rental_agreement_tenants">
            <column name="rental_agreement_id" type="uuid" />
        </createIndex>

        <createIndex indexName="idx_rat_tenant_fk" tableName="rental_agreement_tenants">
            <column name="tenant_id" type="uuid" />
        </createIndex>

        <!-- Migrate existing data: copy tenant-agreement relationships to join table -->
        <sql>
            INSERT INTO rental_agreement_tenants (rental_agreement_id, tenant_id)
            SELECT agreement_id, id
            FROM tenants
        </sql>

        <!-- Drop the unique constraint on (agreement_id, user_id) -->
        <dropIndex tableName="tenants" indexName="idx_tenant_agreement_user_unique" />

        <!-- Drop the foreign key constraint on agreement_id -->
        <dropForeignKeyConstraint baseTableName="tenants" constraintName="fk_tenant_agreement_id" />

        <!-- Drop the index on agreement_id -->
        <dropIndex tableName="tenants" indexName="idx_tenant_agreement_fk" />

        <!-- Drop the agreement_id column from tenants table -->
        <dropColumn tableName="tenants" columnName="agreement_id" />

    </changeSet>

</databaseChangeLog>
